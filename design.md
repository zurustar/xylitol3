# 基本設計書

## 1. 概要

このドキュメントは、Go SIPサーバーの基本的な設計について記述する。
本システムは、SIPシグナリングを処理する「SIPサーバー」、ユーザー管理とセッション監視を行う「Web UIサーバー」、そしてデータを永続化する「ストレージ」の3つの主要コンポーネントから構成される。

## 2. アーキテクチャ図

以下にシステムの高レベルなアーキテクチャを示す。

```
+-----------------+      +---------------------+      +----------------+
|   SIPクライアント  |<---->|     SIPサーバー     |<---->|   ストレージ     |
| (Linphoneなど)  |      |   (internal/sip)    |      | (SQLite)       |
+-----------------+      +----------+----------+      +----------------+
                                    ^
                                    | (アクティブセッション情報)
                                    v
+-----------------+      +----------+----------+      +----------------+
|      ユーザー      |<---->|    Web UIサーバー    |<---->|   ストレージ     |
|  (Webブラウザ)   |      |   (internal/web)    |      | (SQLite)       |
+-----------------+      +---------------------+      +----------------+
```

## 3. 主要コンポーネント

### 3.1. SIPサーバー (`internal/sip/`)
- **責務**: すべてのSIPシグナリングの処理を担当する。
- **機能**:
  - `REGISTER`リクエストを受け付け、ストレージと連携してユーザーを登録する。
  - 登録済みユーザー間の`INVITE`, `BYE`などのSIPメッセージをプロキシする（ステートフル）。
  - ダイジェスト認証を用いてリクエストを検証する。
  - Web UIで設定された特定のユーザーへの着信時に、そのユーザーに紐づけられた音声ファイルをWebRTCを用いてストリーミングする。
- **待受**: UDPおよびTCP (デフォルト: `:5060`)
- **実装**: Goの標準ライブラリと`pion/webrtc`を使用して実装される。

### 3.2. Web UIサーバー (`internal/web/`)
- **責務**: ユーザー管理とアクティブセッション監視のためのWebインターフェースを提供する。
- **機能**:
  - ユーザー（ブラウザ）からのHTTPリクエストを処理する。
  - ユーザーの追加と一覧表示機能を提供する。これらの操作はストレージコンポーネントと連携して行われる。
  - SIPサーバーから現在のアクティブセッション情報を取得し、一覧表示する。
- **待受**: HTTP (デフォルト: `:8080`)
- **実装**: Goの標準ライブラリ`net/http`と`html/template`を使用して実装される。HTMLテンプレートは`internal/web/templates/`に配置される。

### 3.3. ストレージ (`internal/storage/`)
- **責務**: アプリケーションデータの永続化を担当する。
- **機能**:
  - ユーザーの認証情報（ユーザー名、レルム、HA1ハッシュ）を管理する。
  - SIPサーバーのレジストラ機能とWeb UIサーバーのユーザー管理機能に対して、データのCRUD（作成、読み取り、更新、削除）インターフェースを提供する。
- **技術**: バックエンドとしてSQLiteデータベースを使用する。
- **実装**: `github.com/glebarez/go-sqlite`ライブラリを用いて実装される。

## 4. ディレクトリ構造

- `cmd/server/`: アプリケーションのエントリーポイント。サーバーの起動と設定の読み込みを行う。
- `internal/sip/`: SIPプロトコルのコアロジックを格納する。
- `internal/web/`: WebサーバーとUI関連のロジックを格納する。
- `internal/storage/`: データベースとのやり取りを行うロジックを格納する。
- `audio/`: 音声ガイダンスサービスで使用されるWAVファイルなどの静的アセットを格納する。

## 5. 使用技術

- **言語**: Go
- **データベース**: SQLite
  - **ドライバ**: `github.com/glebarez/go-sqlite`
- **WebRTC**: `github.com/pion/webrtc/v3`
- **Webフレームワーク**: Go標準ライブラリ (`net/http`)
